import time
from collections import deque
from ...veri_tabani import veritabani_yoneticisi
import threading
from ..goruntu.image_processing_service import ImageProcessingService
from ..uyari_yoneticisi import uyari_yoneticisi
import asyncio
import uuid as uuid_lib
from dataclasses import dataclass, field


@dataclass
class SistemDurumu:
    # Referanslar
    motor_ref: object = None
    sensor_ref: object = None

    # Veriler
    agirlik: float = None
    uzunluk_motor_verisi: float = None

    # Listeler
    veri_senkronizasyon_listesi: list = field(default_factory=list)
    kabul_edilen_urunler: deque = field(default_factory=deque)
    iade_kuyruÄŸu: deque = field(default_factory=deque)
    
    # Lojikler
    iade_lojik: bool = False
    barkod_lojik: bool = False
    gsi_lojik: bool = False
    gso_lojik: bool = False
    ysi_lojik: bool = False
    yso_lojik: bool = False

    # Alarmlar
    konveyor_alarm: bool = False
    yonlendirici_alarm: bool = False
    seperator_alarm: bool = False

    # Konumlar
    konveyor_konumda: bool = False
    yonlendirici_konumda: bool = False
    seperator_konumda: bool = False

    # Hatalar
    konveyor_hata: bool = False
    yonlendirici_hata: bool = False
    seperator_hata: bool = False

    # Kalibrasyonlar
    yonlendirici_kalibrasyon: bool = False
    seperator_kalibrasyon: bool = False

    # YÃ¶nlendirici iÅŸlem durumu
    yonlendirici_islem_bekliyor: bool = False

    aktif_oturum: dict = field(default_factory=lambda: {
        "aktif": False,
        "sessionId": None,
        "userId": None,
        "paket_uuid_map": {}
    })
    
# ğŸŒ Tekil (global) sistem nesnesi
sistem = SistemDurumu()


image_processing_service = ImageProcessingService()




def oturum_baslat(session_id, user_id):

    """DÄ°M-DB'den gelen oturum baÅŸlatma"""
    sistem.aktif_oturum = {
        "aktif": True,
        "sessionId": session_id,
        "userId": user_id,
        "paket_uuid_map": {}
    }
    
    # Eski Ã¼rÃ¼nleri temizle
    
    print(f"âœ… [OTURUM] DÄ°M-DB oturumu baÅŸlatÄ±ldÄ±: {session_id}, KullanÄ±cÄ±: {user_id}")

async def oturum_sonlandir():
    """Oturumu sonlandÄ±r ve DÄ°M-DB'ye transaction result gÃ¶nder"""
    sistem.sensor_ref.tare()
    if not sistem.aktif_oturum["aktif"]:
        print("âš ï¸ [OTURUM] Aktif oturum yok, sonlandÄ±rma yapÄ±lmadÄ±")
        return

    print(f"ğŸ”š [OTURUM] Oturum sonlandÄ±rÄ±lÄ±yor: {sistem.aktif_oturum['sessionId']}")
    
    # DÄ°M-DB'ye transaction result gÃ¶nder
    try:
        from ...dimdb import istemci
        
        # Kabul edilen Ã¼rÃ¼nleri konteyner formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼r
        containers = {}
        for urun in sistem.kabul_edilen_urunler:
            barcode = urun["barkod"]
            if barcode not in containers:
                containers[barcode] = {
                    "barcode": barcode,
                    "material": urun["materyal_turu"],
                    "count": 0,
                    "weight": 0
                }
            containers[barcode]["count"] += 1
            containers[barcode]["weight"] += urun["agirlik"]
        
        transaction_payload = {
            "guid": str(uuid_lib.uuid4()),
            "timestamp": time.strftime('%Y-%m-%dT%H:%M:%SZ', time.gmtime()),
            "rvm": istemci.RVM_ID,
            "id": sistem.aktif_oturum["sessionId"] + "-tx",
            "firstBottleTime": time.strftime('%Y-%m-%dT%H:%M:%SZ', time.gmtime()),
            "endTime": time.strftime('%Y-%m-%dT%H:%M:%SZ', time.gmtime()),
            "sessionId": sistem.aktif_oturum["sessionId"],
            "userId": sistem.aktif_oturum["userId"],
            "created": time.strftime('%Y-%m-%dT%H:%M:%SZ', time.gmtime()),
            "containerCount": len(sistem.kabul_edilen_urunler),
            "containers": list(containers.values())
        }
        
        # Async fonksiyonu await ile Ã§aÄŸÄ±r
        await istemci.send_transaction_result(transaction_payload)
        print(f"âœ… [OTURUM] Transaction result DÄ°M-DB'ye gÃ¶nderildi")
        
    except Exception as e:
        print(f"âŒ [OTURUM] Transaction result gÃ¶nderme hatasÄ±: {e}")
    
    # Oturumu temizle
    sistem.aktif_oturum = {
        "aktif": False,
        "sessionId": None,
        "userId": None,
        "paket_uuid_map": {}
    }
    
    sistem.kabul_edilen_urunler.clear()
    print(f"ğŸ§¹ [OTURUM] Yerel oturum temizlendi")
    
def motor_referansini_ayarla(motor):
    sistem.motor_ref = motor
    sistem.motor_ref.yonlendirici_sensor_teach()
    
    # Sistem baÅŸlatÄ±lÄ±rken kuyruklarÄ± temizle
    sistem.kabul_edilen_urunler.clear()
    sistem.iade_kuyruÄŸu.clear()
    sistem.veri_senkronizasyon_listesi.clear()
    sistem.yonlendirici_islem_bekliyor = False
    sistem.iade_lojik = False
    sistem.barkod_lojik = False
    
    print("âœ… Motor hazÄ±r - Sistem baÅŸlatÄ±ldÄ± ve kuyruklar temizlendi")

def sensor_referansini_ayarla(sensor):
    sistem.sensor_ref = sensor
    sistem.sensor_ref.teach()

def barkod_verisi_al(barcode):
    
    # Ä°ade aktifse yeni barkod iÅŸleme
    if sistem.iade_lojik:
        print(f"ğŸš« [Ä°ADE AKTIF] Barkod gÃ¶rmezden gelindi: {barcode}")
        return

    if sistem.barkod_lojik:
        print(f"âš ï¸ [BARKOD] Ã–nceki barkod iÅŸlemesi tamamlanmadÄ±, yeni barkod gÃ¶rmezden gelindi: {barcode}")
        return

    # Her barkod iÃ§in benzersiz UUID oluÅŸtur
    paket_uuid = str(uuid_lib.uuid4())
    sistem.aktif_oturum["paket_uuid_map"][barcode] = paket_uuid

    sistem.barkod_lojik = True
    #veri_senkronizasyonu(barkod=barcode)

    veri_senkronizasyonu(barkod=barcode)
    print(f"\nğŸ“‹ [YENÄ° ÃœRÃœN] Barkod okundu: {barcode}, UUID: {paket_uuid}")

def goruntu_isleme_tetikle():
    goruntu_sonuc = image_processing_service.capture_and_process()
    print(f"\nğŸ“· [GÃ–RÃœNTÃœ Ä°ÅLEME] SonuÃ§: {goruntu_sonuc}")
    veri_senkronizasyonu(materyal_turu=goruntu_sonuc.type.value, uzunluk=float(goruntu_sonuc.height_mm), genislik=float(goruntu_sonuc.width_mm))

def veri_senkronizasyonu(barkod=None, agirlik=None, materyal_turu=None, uzunluk=None, genislik=None):
    # EÄŸer kuyruk boÅŸsa, yeni Ã¼rÃ¼n baÅŸlat
    if not sistem.veri_senkronizasyon_listesi:
        sistem.veri_senkronizasyon_listesi.append({
            'barkod': None,
            'agirlik': None,
            'materyal_turu': None,
            'uzunluk': None,
            'genislik': None
        })

    # Her zaman FIFO mantÄ±ÄŸÄ±nda en Ã¶ndeki Ã¼rÃ¼nÃ¼ gÃ¼ncelle
    urun = sistem.veri_senkronizasyon_listesi[0]

    if barkod is not None:
        urun['barkod'] = barkod
    if agirlik is not None:
        urun['agirlik'] = agirlik
    if materyal_turu is not None:
        urun['materyal_turu'] = materyal_turu
    if uzunluk is not None:
        urun['uzunluk'] = uzunluk
    if genislik is not None:
        urun['genislik'] = genislik

    # EÄŸer tÃ¼m alanlar dolduysa Ã¼rÃ¼nÃ¼ iÅŸleme al

    if urun['barkod'] is None and any(urun[k] is not None for k in ['agirlik', 'materyal_turu', 'uzunluk', 'genislik']):
        print(f"âŒ [VERÄ° SENKRONÄ°ZASYONU] KarÅŸÄ±laÅŸtÄ±rma hatasÄ± - barkod olmadan veri geldi: {urun}")
        
        # Barkodsuz Ã¼rÃ¼n iÃ§in iade iÅŸlemini baÅŸlat
        giris_iade_et("Barkod okunamadÄ±")

        sistem.veri_senkronizasyon_listesi.pop(0)  # hatalÄ± Ã¼rÃ¼nÃ¼ sil
        print(f"ğŸ”„ [VERÄ° SENKRONÄ°ZASYONU] GÃ¼ncel kuyruk durumu: {sistem.veri_senkronizasyon_listesi}")
        return  # Ã§Ä±kÄ±ÅŸ yap

    if all(urun[k] is not None for k in urun):
        print(f"âœ… [VERÄ° SENKRONÄ°ZASYONU] TÃ¼m veriler alÄ±ndÄ±: {urun}")
        dogrulama(urun['barkod'], urun['agirlik'], urun['materyal_turu'], urun['uzunluk'], urun['genislik'])
        sistem.barkod_lojik = False
        sistem.veri_senkronizasyon_listesi.pop(0)  # iÅŸlenen Ã¼rÃ¼nÃ¼ kuyruktan Ã§Ä±kar
    print(f"ğŸ”„ [VERÄ° SENKRONÄ°ZASYONU] GÃ¼ncel kuyruk durumu: {sistem.veri_senkronizasyon_listesi}")

def dogrulama(barkod, agirlik, materyal_turu, uzunluk, genislik):

    print(f"\nğŸ“Š [DOÄRULAMA] Mevcut durum: barkod={barkod}, aÄŸÄ±rlÄ±k={agirlik}, materyal tÃ¼rÃ¼={materyal_turu}, uzunluk={uzunluk}, geniÅŸlik={genislik}")

    urun = veritabani_yoneticisi.barkodu_dogrula(barkod)
    
    if not urun:
        print(f"âŒ [DOÄRULAMA] ÃœrÃ¼n veritabanÄ±nda bulunamadÄ±: {barkod}")
        dimdb_bildirimi_gonder(barkod, agirlik, materyal_turu, uzunluk, genislik, False, 1, "ÃœrÃ¼n veritabanÄ±nda yok")
        giris_iade_et("ÃœrÃ¼n veritabanÄ±nda yok")
        return

    min_agirlik = urun.get('packMinWeight')
    max_agirlik = urun.get('packMaxWeight')
    min_genislik = urun.get('packMinWidth')
    max_genislik = urun.get('packMaxWidth')
    min_uzunluk = urun.get('packMinHeight')
    max_uzunluk = urun.get('packMaxHeight')
    materyal_id = urun.get('material')    

    print(f"ğŸ“Š [DOÄRULAMA] Min Agirlik: {min_agirlik}, Max Agirlik: {max_agirlik}, Min GeniÅŸlik: {min_genislik}, Max GeniÅŸlik: {max_genislik}, Min Uzunluk: {min_uzunluk}, Max Uzunluk: {max_uzunluk}, Materyal_id: {materyal_id}")

    print(f"ğŸ“Š [DOÄRULAMA] Ã–lÃ§Ã¼len aÄŸÄ±rlÄ±k: {agirlik} gr")
    
    agirlik_kabul = False
    if min_agirlik is None and max_agirlik is None:
        agirlik_kabul = True
    elif min_agirlik is not None and max_agirlik is not None:
        agirlik_kabul = (min_agirlik-20<= agirlik <= max_agirlik+20)
    elif min_agirlik is not None:
        agirlik_kabul = (agirlik >= min_agirlik-20)
    elif max_agirlik is not None:
        agirlik_kabul = (agirlik <= max_agirlik+20)

    print(f"ğŸ“Š [DOÄRULAMA] AÄŸÄ±rlÄ±k kontrol sonucu: {agirlik_kabul}")

    if not agirlik_kabul:
        #dimdb_bildirimi_gonder(barkod, agirlik, materyal_turu, uzunluk, genislik, False, 2, "AÄŸÄ±rlÄ±k sÄ±nÄ±rlarÄ± dÄ±ÅŸÄ±nda")
        giris_iade_et("AÄŸÄ±rlÄ±k sÄ±nÄ±rlarÄ± dÄ±ÅŸÄ±nda")
        return

    if min_genislik-100 <= genislik <= max_genislik+100:
        print(f"âœ… [DOÄRULAMA] GeniÅŸlik kontrolÃ¼ geÃ§ti: {genislik} mm")
    else:
        print(f"âŒ [DOÄRULAMA] GeniÅŸlik sÄ±nÄ±rlarÄ± dÄ±ÅŸÄ±nda: {genislik} mm")
        #dimdb_bildirimi_gonder(barkod, agirlik, materyal_turu, uzunluk, genislik, False, 3, "GeniÅŸlik sÄ±nÄ±rlarÄ± dÄ±ÅŸÄ±nda")
        giris_iade_et("GeniÅŸlik sÄ±nÄ±rlarÄ± dÄ±ÅŸÄ±nda")
        return

    if min_uzunluk-100 <= uzunluk <= max_uzunluk+100 :
        print(f"âœ… [DOÄRULAMA] Uzunluk kontrolÃ¼ geÃ§ti: {uzunluk} mm")
    else:
        print(f"âŒ [DOÄRULAMA] Uzunluk sÄ±nÄ±rlarÄ± dÄ±ÅŸÄ±nda: {uzunluk} mm")
        #dimdb_bildirimi_gonder(barkod, agirlik, materyal_turu, uzunluk, genislik, False, 4, "Uzunluk sÄ±nÄ±rlarÄ± dÄ±ÅŸÄ±nda")
        giris_iade_et("Uzunluk sÄ±nÄ±rlarÄ± dÄ±ÅŸÄ±nda")
        return

    if materyal_id != materyal_turu:
        print(f"âŒ [DOÄRULAMA] Materyal tÃ¼rÃ¼ uyuÅŸmuyor: beklenen {materyal_id}, gelen {materyal_turu}")
        #dimdb_bildirimi_gonder(barkod, agirlik, materyal_turu, uzunluk, genislik, False, 5, "Materyal tÃ¼rÃ¼ uyuÅŸmuyor")
        giris_iade_et("Materyal tÃ¼rÃ¼ uyuÅŸmuyor")
        return
    
    print(f"âœ… [DOÄRULAMA] Materyal tÃ¼rÃ¼ kontrolÃ¼ geÃ§ti: {materyal_turu}")

    # TÃ¼m kontroller geÃ§ti, Ã¼rÃ¼nÃ¼ kabul et
    sistem.kabul_edilen_urunler.append({
        'barkod': barkod,
        'agirlik': agirlik,
        'materyal_turu': materyal_turu,
        'uzunluk': uzunluk,
        'genislik': genislik,
    })

    print(f"âœ… [DOÄRULAMA] ÃœrÃ¼n kabul edildi ve kuyruÄŸa eklendi: {barkod}")
    print(f"ğŸ“¦ [KUYRUK] Toplam kabul edilen Ã¼rÃ¼n sayÄ±sÄ±: {len(sistem.kabul_edilen_urunler)}")

    # DÄ°M-DB'ye kabul bildirimi gÃ¶nder
    #dimdb_bildirimi_gonder(barkod, agirlik, materyal_turu, uzunluk, genislik, True, 0, "Ambalaj Kabul Edildi")

def yonlendirici_hareket():
    # Depozito iade makinesi mantÄ±ÄŸÄ±:
    # 1. Kabul edilen Ã¼rÃ¼n varsa -> Ã–nce onu yÃ¶nlendir, sonra iade iÅŸlemi yap
    # 2. Sadece iade varsa -> Hemen iade iÅŸlemi yap
    
    # Ã–ncelik kabul edilen Ã¼rÃ¼nlerde
    if sistem.kabul_edilen_urunler:
        # En eski kabul edilen Ã¼rÃ¼nÃ¼ al
        urun = sistem.kabul_edilen_urunler.popleft()
        materyal_id = urun.get('materyal_turu')
        
        materyal_isimleri = {1: "PET", 2: "CAM", 3: "ALÃœMÄ°NYUM"}
        materyal_adi = materyal_isimleri.get(materyal_id, "BÄ°LÄ°NMEYEN")
        
        print(f"\nğŸ”„ [YÃ–NLENDÄ°RME] {materyal_adi} Ã¼rÃ¼n iÅŸleniyor: {urun['barkod']}")
        print(f"ğŸ“¦ [KUYRUK] Kalan kabul edilen Ã¼rÃ¼n sayÄ±sÄ±: {len(sistem.kabul_edilen_urunler)}")

        if sistem.motor_ref:
            if materyal_id == 2:  # Cam
                sistem.motor_ref.konveyor_dur()
                sistem.motor_ref.yonlendirici_cam()
                print(f"ğŸŸ¦ [CAM] Cam yÃ¶nlendiricisine gÃ¶nderildi")
            else:  # Plastik/Metal
                sistem.motor_ref.konveyor_dur()
                sistem.motor_ref.yonlendirici_plastik()
                print(f"ğŸŸ© [PLASTÄ°K] Plastik yÃ¶nlendiricisine gÃ¶nderildi")
        
        # YÃ¶nlendirici iÅŸlem bekleme durumunu iÅŸaretle
        sistem.yonlendirici_islem_bekliyor = True
        print(f"âœ… [YÃ–NLENDÄ°RME] Kabul edilen Ã¼rÃ¼n yÃ¶nlendiriciye gÃ¶nderildi, tamamlanmasÄ± bekleniyor\n")
        return
    
    # Kabul edilen Ã¼rÃ¼n yoksa iade kuyruÄŸunu kontrol et
    # Ä°ade iÅŸlemi iÃ§in yÃ¶nlendirici iÅŸlem beklemesine gerek yok (sadece iade varsa hemen yap)
    if sistem.iade_kuyruÄŸu:
        iade_sebebi = sistem.iade_kuyruÄŸu.popleft()
        print(f"\nğŸ”„ [Ä°ADE YÃ–NLENDÄ°RME] Ä°ade iÅŸlemi baÅŸlatÄ±lÄ±yor: {iade_sebebi}")
        print(f"ğŸ“¦ [Ä°ADE KUYRUK] Kalan iade sayÄ±sÄ±: {len(sistem.iade_kuyruÄŸu)}")
        
        if sistem.motor_ref:
            sistem.motor_ref.konveyor_geri()
            print(f"ğŸ”™ [Ä°ADE] ÃœrÃ¼n geri gÃ¶nderiliyor: {iade_sebebi}")
        
        sistem.iade_lojik = True
        print(f"âœ… [Ä°ADE YÃ–NLENDÄ°RME] Ä°ade iÅŸlemi baÅŸlatÄ±ldÄ±\n")
        return
    
    # Her iki kuyruk da boÅŸsa
    if not sistem.kabul_edilen_urunler and not sistem.iade_kuyruÄŸu:
        print(f"âš ï¸ [YÃ–NLENDÄ°RME] Hem kabul edilen Ã¼rÃ¼n hem de iade kuyruÄŸu boÅŸ, yÃ¶nlendirme yapÄ±lamadÄ±")


def lojik_yoneticisi():
    while True:

        if sistem.gsi_lojik:
            sistem.gsi_lojik = False
            if sistem.iade_lojik:
                print("ğŸš« [Ä°ADE AKTIF] ÅiÅŸeyi AlÄ±nÄ±z.")
                time.sleep(0.25)
                sistem.motor_ref.konveyor_dur()
            else:
                print("ğŸ”„ [LOJÄ°K] GSI lojik iÅŸlemleri baÅŸlatÄ±ldÄ±")
                sistem.motor_ref.konveyor_ileri()
        
        if sistem.gso_lojik:
            sistem.gso_lojik = False
            if sistem.iade_lojik:
                print("ÃœrÃ¼nÃ¼ aldÄ±. Sistem Tekrar Aktif TeÅŸekkÃ¼rler.")
                sistem.iade_kuyruÄŸu.clear()  # Ä°ade kuyruÄŸunu temizle
                sistem.iade_lojik = False
                sistem.barkod_lojik = False
            else:
                if sistem.barkod_lojik:
                    print("[GSO] Sistem Normal Ã‡alÄ±ÅŸÄ±yor. GÃ¶rÃ¼ntÃ¼ Ä°ÅŸleme BaÅŸlatÄ±lÄ±yor.")
                    goruntu_isleme_tetikle()
                else:
                    giris_iade_et("Barkod okunamadÄ±")
        
        if sistem.yso_lojik:
            sistem.yso_lojik = False
            print("ğŸ”„ [LOJÄ°K] YSO lojik iÅŸlemleri baÅŸlatÄ±ldÄ±")
            yonlendirici_hareket()

        if sistem.yonlendirici_konumda:
            sistem.yonlendirici_konumda = False
            
            # EÄŸer yÃ¶nlendirici iÅŸlem bekleniyorsa, iÅŸlem tamamlandÄ±
            if sistem.yonlendirici_islem_bekliyor:
                sistem.yonlendirici_islem_bekliyor = False
                print("âœ… [LOJÄ°K] YÃ¶nlendirici iÅŸlem tamamlandÄ±")
                
                # Åimdi iade kuyruÄŸunu kontrol et
                if sistem.iade_kuyruÄŸu:
                    print("ğŸ”„ [LOJÄ°K] YÃ¶nlendirici iÅŸlem bitti, iade iÅŸlemi baÅŸlatÄ±lÄ±yor")
                    # Bir sonraki YSO sinyalinde iade iÅŸlemi yapÄ±lacak
            
            # FIFO mantÄ±ÄŸÄ±: Ã¶nce kabul edilen Ã¼rÃ¼nler, sonra iade kuyruÄŸu, sonra senkronizasyon
            if len(sistem.veri_senkronizasyon_listesi)>0 or len(sistem.kabul_edilen_urunler)>0:
                print("ğŸ”„ [LOJÄ°K] YÃ¶nlendirici konumda, konveyÃ¶r ileri")
                sistem.motor_ref.konveyor_ileri()
            if sistem.iade_lojik and len(sistem.iade_kuyruÄŸu)>0:
                print("âœ… [LOJÄ°K] YÃ¶nlendirici konumda, konveyÃ¶r dur")
                sistem.motor_ref.konveyor_geri()


        if sistem.agirlik is not None:
            if sistem.barkod_lojik:
                print(f"âš–ï¸ [AÄIRLIK] Ã–lÃ§Ã¼len aÄŸÄ±rlÄ±k: {sistem.agirlik} gr")
                veri_senkronizasyonu(agirlik=sistem.agirlik)
                sistem.agirlik = None  # SÄ±fÄ±rla
            else:
                print(f"âš ï¸ [AÄIRLIK] Ã–lÃ§Ã¼len aÄŸÄ±rlÄ±k var ama barkod lojik aktif deÄŸil: {sistem.agirlik} gr")
                sistem.agirlik = None  # SÄ±fÄ±rla
        
def giris_iade_et(sebep):
    print(f"\nâŒ [GÄ°RÄ°Å Ä°ADESÄ°] Sebep: {sebep}")
    
    # Ä°ade iÅŸlemini kuyruÄŸa ekle (FIFO mantÄ±ÄŸÄ± iÃ§in)
    sistem.iade_kuyruÄŸu.append(sebep)
    print(f"ğŸ“‹ [Ä°ADE KUYRUK] Ä°ade kuyruÄŸuna eklendi: {sebep}")
    print(f"ğŸ“¦ [Ä°ADE KUYRUK] Toplam bekleyen iade sayÄ±sÄ±: {len(sistem.iade_kuyruÄŸu)}")

def mesaj_isle(mesaj):

    mesaj = mesaj.strip().lower()
    
    if mesaj == "oturum_var":
        print(f"ğŸŸ¢ [OTURUM] Aktif oturum baÅŸlatÄ±ldÄ±")
        sistem.motor_ref.motorlari_aktif_et()
        sistem.sensor_ref.tare()
        sistem.motor_ref.konveyor_dur()
        sistem.sensor_ref.led_ac()
        sistem.sensor_ref.doluluk_oranÄ±()

    if mesaj.startswith("a:"):
        sistem.agirlik = float(mesaj.split(":")[1].replace(",", "."))
    if mesaj == "gsi":
        sistem.gsi_lojik = True
    if mesaj == "gso":
        sistem.gso_lojik = True
    if mesaj == "yso":
        sistem.yso_lojik = True
    if mesaj == "ysi":
        sistem.ysi_lojik = True
    if mesaj.startswith("m:"):
        sistem.uzunluk_motor_verisi = float(mesaj.split(":")[1].replace(",", "."))
    if mesaj == "kma":
        sistem.konveyor_alarm = True
    if mesaj == "yma":
        sistem.yonlendirici_alarm = True
    if mesaj == "sma":
        sistem.seperator_alarm = True
    if mesaj == "kmk":
        sistem.konveyor_konumda = True
    if mesaj == "ymk":
        sistem.yonlendirici_konumda = True
    if mesaj == "smk":  
        sistem.seperator_konumda = True
    if mesaj == "kmh":
        sistem.konveyor_hata = True
    if mesaj == "ymh":  
        sistem.yonlendirici_hata = True
    if mesaj == "smh":  
        sistem.seperator_hata = True
    if mesaj == "ykt":
        sistem.yonlendirici_kalibrasyon = True
    if mesaj == "skt":  
        sistem.seperator_kalibrasyon = True


t1 = threading.Thread(target=lojik_yoneticisi, daemon=True)
# t2 = threading.Thread(target=goruntu_isleme_tetikle, daemon=True)  # Otomatik baÅŸlatma kaldÄ±rÄ±ldÄ±
t1.start()
# t2.start()  # GÃ¶rÃ¼ntÃ¼ iÅŸleme sadece GSO sinyalinde tetiklenecek


# Erikli barkod: 1923026353360
# Erikli bÃ¼yÃ¼k barkod: 1923026353391
# Kuzeyden barkod: 19270737
# Nestle barkod: 1923026353469
# Damla barkod: 8333445997848